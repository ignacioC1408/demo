<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>CatÃ¡logo - Punto FÃ¡cil</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="/css/catalogo.css">
  <link rel="icon" href="/images/logo.png">
</head>
<body>

  <!-- NAVBAR -->
  <nav class="topbar d-flex align-items-center justify-content-between px-4">
    <div class="d-flex align-items-center gap-3">
      <img src="/images/logo.png" alt="Logo" class="logo">
      <h5 class="m-0">Punto FÃ¡cil</h5>
    </div>

    <div class="d-flex align-items-center gap-2 flex-wrap justify-content-end">
      <span class="text-white me-2" th:text="'Hola, ' + ${usuario.nombre}"></span>
      <a th:href="@{/usuario/carrito/ver}" class="btn btn-sm">ðŸ›’ Carrito</a>
      <a th:href="@{/usuario/pedidos}" class="btn btn-sm">Pedidos</a>
      <a th:href="@{/usuario/productos}" class="btn btn-sm active">CatÃ¡logo</a>
      <a th:href="@{/logout}" class="btn btn-sm">Cerrar sesiÃ³n</a>
    </div>
  </nav>

  <!-- CONTENIDO PRINCIPAL -->
  <div class="container py-5">
    
    <!-- FILTRO Y BÃšSQUEDA -->
    <div class="filter-bar mb-4 d-flex justify-content-between align-items-center flex-wrap">
      <h2 class="welcome-text mb-0">Bienvenidos</h2>
      <div class="d-flex align-items-center gap-2 flex-wrap">
        <label for="categoria" class="fw-semibold text-primary mb-0">CategorÃ­a:</label>
        <select id="categoria" name="categoria" class="form-select form-select-sm w-auto">
          <option value="">Todas</option>
          <option th:each="c : ${categorias}" th:value="${c.id}" th:text="${c.nombre}" th:selected="${c.id} == ${categoriasSeleccionada}"></option>
        </select>
        <input id="buscar" name="buscar" type="text" th:value="${busqueda}"class="form-control form-control-sm w-auto" placeholder="Buscar producto...">
        <button id="btnBuscar" class="btn btn-primary btn-sm">Buscar</button>
      </div>
    </div>

    <!-- LISTA DE PRODUCTOS -->
    <div class="row g-3 justify-content-center">
      <div class="col-md-3 col-sm-6" th:each="p : ${productos}">
        <div class="card product-card text-center">
          <img src="/images/default.png" class="card-img-top" alt="Producto">
          <div class="card-body p-2">
            <h6 class="card-title mb-1" th:text="${p.nombre}">Producto</h6>
            <p class="small mb-1"><strong>CÃ³digo:</strong> <span th:text="${p.codigoProducto}"></span></p>
            <p class="small mb-1"><strong>Stock:</strong> <span th:text="${p.stock}"></span> <span th:text="${p.unidadMedida}"></span></p>
            <p class="price" th:text="'$' + ${p.precioBase}"></p>

            <div class="d-flex justify-content-center align-items-center gap-2 mb-2">
              <button type="button" class="btn-qty btn-minus">âˆ’</button>
              <input type="number" class="qty-input" value="1" min="1" step="1">
              <button type="button" class="btn-qty btn-plus">+</button>
            </div>

            <form th:action="@{/usuario/carrito/agregar}" method="post" class="add-to-cart-form">
              <input type="hidden" name="idProducto" th:value="${p.id}">
              <input type="hidden" name="cantidad" value="1">
              <button type="submit" class="btn btn-primary btn-sm w-100">Agregar</button>
            </form>
          </div>
        </div>
      </div>
    </div>

    <!-- PAGINACIÃ“N -->
    <div class="pagination mt-4" th:if="${totalPaginas > 1}">
      <a class="btn btn-outline-secondary btn-sm"
         th:href="@{/usuario/productos(p=${pagina-1}, categoria=${param.categoria}, q=${param.q})}"
         th:if="${pagina > 1}">Anterior</a>
      <span>PÃ¡gina <span th:text="${pagina}">1</span> de <span th:text="${totalPaginas}">1</span></span>
      <a class="btn btn-outline-secondary btn-sm"
         th:href="@{/usuario/productos(p=${pagina+1}, categoria=${param.categoria}, q=${param.q})}"
         th:if="${pagina < totalPaginas}">Siguiente</a>
    </div>

  </div>

  <!-- JS -->
  <script>
    // Buscar por texto o categorÃ­a
    document.getElementById('btnBuscar').addEventListener('click', () => {
      const categoria = document.getElementById('categoria').value;
      const q = document.getElementById('buscar').value || '';
      let url = '/usuario/productos?';
      if (categoria) url += 'categoria=' + encodeURIComponent(categoria) + '&';
      if (q) url += 'q=' + encodeURIComponent(q);
      window.location.href = url;
    });

    // Control cantidad (solo enteros)
    document.querySelectorAll('.card').forEach(card => {
      const input = card.querySelector('.qty-input');
      const minus = card.querySelector('.btn-minus');
      const plus = card.querySelector('.btn-plus');
      const hiddenCantidad = card.querySelector('input[name="cantidad"]');

      const sanitize = () => {
        let val = parseInt(input.value, 10);
        if (isNaN(val) || val < 1) val = 1;
        input.value = val;
        hiddenCantidad.value = val;
      };

      minus.addEventListener('click', () => {
        input.value = Math.max(1, parseInt(input.value, 10) - 1);
        sanitize();
      });

      plus.addEventListener('click', () => {
        input.value = parseInt(input.value, 10) + 1;
        sanitize();
      });

      input.addEventListener('input', sanitize);
      input.addEventListener('blur', sanitize);
    });
  </script>

</body>
</html>
